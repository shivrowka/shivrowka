<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>shivrowka</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#111;
  --accent:linear-gradient(135deg,#667eea,#764ba2);
}
body.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#ffffff;
  --accent:linear-gradient(135deg,#06b6d4,#3b82f6);
}
body{
  margin:0;
  padding:20px;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,Arial,sans-serif;
  transition:.3s;
}
.logo{
  text-align:center;
  font-size:26px;
  letter-spacing:6px;
  margin-bottom:10px;
}
.status{
  text-align:center;
  margin-bottom:15px;
  font-weight:600;
}
.theme{
  text-align:right;
  font-size:20px;
  cursor:pointer;
  margin-bottom:10px;
}
.card{
  background:var(--card);
  padding:20px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.1);
}
textarea,input{
  width:100%;
  border:none;
  border-radius:14px;
  padding:14px;
  font-size:16px;
  margin-bottom:15px;
  background:rgba(0,0,0,.05);
  color:var(--text);
}
body.dark textarea,
body.dark input{
  background:rgba(255,255,255,.08);
}
.button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
  background:var(--accent);
  transition:.2s;
  margin-bottom:10px;
}
.button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(0,0,0,.2);
}
.copyBtn{ background:#10b981; }
#downloadLink{
  display:none;
  margin-top:10px;
  text-decoration:none;
  font-weight:600;
}
</style>
</head>
<body>

<div class="logo">shivrowka</div>
<div class="theme" onclick="toggleTheme()">üåô</div>
<div class="status" id="status">üîì –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç</div>

<div class="card">
  <textarea id="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª..."></textarea>

  <input id="key" placeholder="–ù–æ–º–µ—Ä (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)" inputmode="numeric">

  <input type="file" id="fileInput">

  <button class="button" onclick="encrypt()">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button class="button" onclick="decrypt()">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
  <button class="button copyBtn" onclick="copyText()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>

  <a id="downloadLink">üì• –°–∫–∞—á–∞—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª</a>
</div>

<script>
// ====== –ù–ê–°–¢–†–û–ô–ö–ò ======
const MARK = "\u200B\u200C"; // –Ω–µ–≤–∏–¥–∏–º–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞
const ITERATIONS = 150000;
const SALT = "shivrowka_salt";

const textArea = document.getElementById("text");
const keyInput = document.getElementById("key");
const fileInput = document.getElementById("fileInput");
const downloadLink = document.getElementById("downloadLink");

// ====== –¢–ï–ú–ê ======
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",
    document.body.classList.contains("dark") ? "dark" : "light"
  );
}
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
}

// ====== –°–¢–ê–¢–£–° ======
function setStatus(encrypted){
  document.getElementById("status").textContent =
    encrypted ? "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ" : "üîì –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç";
}

// ====== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–Æ–ß–ê ======
async function deriveKey(number){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    enc.encode(number),
    {name:"PBKDF2"},
    false,
    ["deriveKey"]
  );

  return crypto.subtle.deriveKey(
    {
      name:"PBKDF2",
      salt:enc.encode(SALT),
      iterations:ITERATIONS,
      hash:"SHA-256"
    },
    keyMaterial,
    {name:"AES-GCM",length:256},
    false,
    ["encrypt","decrypt"]
  );
}

// ====== –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê ======
fileInput.addEventListener("change", async ()=>{
  const file = fileInput.files[0];
  if(!file) return;

  const buffer = await file.arrayBuffer();
  const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));

  textArea.value = "FILE::" + file.name + "::" + file.type + "::" + base64;
  setStatus(false);
  downloadLink.style.display="none";
});

// ====== –®–ò–§–†–û–í–ê–ù–ò–ï ======
async function encrypt(){
  const number = keyInput.value;

  if(!number.match(/^[0-9]+$/)){
    alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)");
    return;
  }

  if(textArea.value.startsWith(MARK)){
    alert("–¢–µ–∫—Å—Ç —É–∂–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω");
    return;
  }

  const key = await deriveKey(number);
  const iv = crypto.getRandomValues(new Uint8Array(12));

  const encrypted = await crypto.subtle.encrypt(
    {name:"AES-GCM",iv},
    key,
    new TextEncoder().encode(textArea.value)
  );

  const combined = new Uint8Array(iv.length + encrypted.byteLength);
  combined.set(iv);
  combined.set(new Uint8Array(encrypted),iv.length);

  textArea.value = MARK + btoa(String.fromCharCode(...combined));
  setStatus(true);
  downloadLink.style.display="none";
}

// ====== –†–ê–°–®–ò–§–†–û–í–ö–ê ======
async function decrypt(){
  const number = keyInput.value;

  if(!number.match(/^[0-9]+$/)){
    alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)");
    return;
  }

  if(!textArea.value.startsWith(MARK)){
    alert("–¢–µ–∫—Å—Ç —É–∂–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω");
    return;
  }

  try{
    const clean = textArea.value.slice(MARK.length);
    const raw = atob(clean);
    const bytes = new Uint8Array([...raw].map(c=>c.charCodeAt(0)));

    const iv = bytes.slice(0,12);
    const data = bytes.slice(12);

    const key = await deriveKey(number);

    const decrypted = await crypto.subtle.decrypt(
      {name:"AES-GCM",iv},
      key,
      data
    );

    const result = new TextDecoder().decode(decrypted);

    if(result.startsWith("FILE::")){
      const parts = result.split("::");
      const fileName = parts[1];
      const fileType = parts[2];
      const base64Data = parts[3];

      const binary = atob(base64Data);
      const fileBytes = new Uint8Array([...binary].map(c=>c.charCodeAt(0)));

      const blob = new Blob([fileBytes], {type:fileType});
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = fileName;
      downloadLink.style.display="block";

      textArea.value = "[–§–∞–π–ª —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω]";
    } else {
      textArea.value = result;
      downloadLink.style.display="none";
    }

    setStatus(false);

  }catch{
    textArea.value="–õ–≤—â–∂—ã–ª—á–¥–∞–æ–¥–∞—à–µ–∑–ó—è—Ö–¥–∫–∑—É–∂–≤—å—Å–ª—Å—â–∂";
  }
}

// ====== –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ======
function copyText(){
  navigator.clipboard.writeText(textArea.value);
}

// ====== PWA ======
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
